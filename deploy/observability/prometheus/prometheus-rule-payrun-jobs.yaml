apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: payrun-jobs
  labels:
    app.kubernetes.io/name: us-payroll-platform
    app.kubernetes.io/component: observability
spec:
  groups:
    - name: payrun-jobs-rabbit
      rules:
        - alert: PayrunFinalizeEmployeeQueueBacklogHigh
          expr: worker_rabbit_queue_depth{queue="payrun-finalize-employee-jobs"} > 5000
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: Payrun finalize-employee backlog high
            description: Main finalize-employee queue depth is > 5000 for 10m. Workers may not be keeping up.

        - alert: PayrunFinalizeEmployeeQueueBacklogCritical
          expr: worker_rabbit_queue_depth{queue="payrun-finalize-employee-jobs"} > 20000
          for: 10m
          labels:
            severity: critical
          annotations:
            summary: Payrun finalize-employee backlog critical
            description: Main finalize-employee queue depth is > 20000 for 10m.

        - alert: PayrunFinalizeEmployeeDlqHasMessages
          expr: worker_rabbit_queue_depth{queue="payrun-finalize-employee-jobs-dlq"} > 0
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: Finalize-employee DLQ has messages
            description: Messages are landing in the DLQ. Investigate root cause before replaying.

        - alert: PayrunFinalizeEmployeeTerminalFailureRateHigh
          expr: |
            sum(rate(worker_payrun_finalize_employee_total{outcome="failed_terminal"}[10m]))
            /
            clamp_min(sum(rate(worker_payrun_finalize_employee_total{outcome=~"succeeded|failed_terminal"}[10m])), 1e-9)
            > 0.001
          for: 10m
          labels:
            severity: critical
          annotations:
            summary: Finalize-employee terminal failure ratio > 0.1%
            description: Terminal failures exceed 0.1% over 10m; likely data/config issue or systemic dependency failure.

        - alert: PayrunFinalizeEmployeeRetryStorm
          expr: sum(rate(worker_payrun_finalize_employee_total{outcome="retry_enqueued"}[5m])) > 50
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: High retry enqueue rate for finalize-employee
            description: Retries are being enqueued at > 50/min for 10m. Downstream dependency may be degraded.

        - alert: PayrunFinalizeEmployeeWorkerClientErrors
          expr: sum(rate(worker_payrun_finalize_employee_total{outcome="client_error"}[5m])) > 5
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: Worker client errors calling orchestrator finalize endpoint
            description: Worker is seeing client errors calling orchestrator per-item finalize endpoint.

        - alert: OrchestratorPerItemFinalizeLatencyP95High
          expr: |
            histogram_quantile(
              0.95,
              sum by (le) (rate(orchestrator_payrun_item_finalize_duration_seconds_bucket[5m]))
            ) > 2
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: Orchestrator per-item finalize p95 latency > 2s
            description: Per-item finalize is slower than expected; may indicate downstream slowness (HR/Tax/Labor/DB).

        - alert: WorkerFinalizeEmployeeLatencyP95High
          expr: |
            histogram_quantile(
              0.95,
              sum by (le) (rate(worker_payrun_finalize_employee_duration_seconds_bucket[5m]))
            ) > 3
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: Worker finalize-employee p95 duration > 3s
            description: Worker observed p95 finalize call duration is high.
